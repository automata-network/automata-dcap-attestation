// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.0;

import "../pcs/PCSSetupBase.t.sol";
import "../mock/MockTcbDao.sol";
import {TCBConstants} from "./TCBConstants.t.sol";

contract TcbMockTest is PCSSetupBase, TCBConstants {
    MockTcbDao tcb;

    function setUp() public override {
        super.setUp();

        tcb = new MockTcbDao(
            address(pccsStorage),
            P256_VERIFIER, 
            address(pcs), 
            address(fsmpcTcbLib), 
            address(x509Lib)
        );

        vm.prank(admin);
        pccsStorage.updateDao(address(pcs), address(pck), address(tcb), address(enclaveIdDao));
    }

    function testMockFmspcTcbTdxV3() public {
        vm.warp(1715843418);
        // vm.warp(1733786254);

        // uint8 tcbType = 1;
        // string memory fmspcStr = "90c06f000000";
        bytes6 fmspcBytes = hex"90c06f000000";
        // uint32 version = 3;

        // TcbInfoJsonObj memory tcbInfoObj = TcbInfoJsonObj({
        //     tcbInfoStr: string(hex"7b226964223a22544458222c2276657273696f6e223a332c22697373756544617465223a22323032342d31322d30395431323a35393a32305a222c226e657874557064617465223a22323032352d30312d30385431323a35393a32305a222c22666d737063223a22423043303646303030303030222c227063654964223a2230303030222c2274636254797065223a302c227463624576616c756174696f6e446174614e756d626572223a31372c227464784d6f64756c65223a7b226d727369676e6572223a22303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c2261747472696275746573223a2230303030303030303030303030303030222c22617474726962757465734d61736b223a2246464646464646464646464646464646227d2c227464784d6f64756c654964656e746974696573223a5b7b226964223a225444585f3033222c226d727369676e6572223a22303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c2261747472696275746573223a2230303030303030303030303030303030222c22617474726962757465734d61736b223a2246464646464646464646464646464646222c227463624c6576656c73223a5b7b22746362223a7b2269737673766e223a337d2c2274636244617465223a22323032342d30332d31335430303a30303a30305a222c22746362537461747573223a225570546f44617465227d5d7d2c7b226964223a225444585f3031222c226d727369676e6572223a22303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030222c2261747472696275746573223a2230303030303030303030303030303030222c22617474726962757465734d61736b223a2246464646464646464646464646464646222c227463624c6576656c73223a5b7b22746362223a7b2269737673766e223a347d2c2274636244617465223a22323032342d30332d31335430303a30303a30305a222c22746362537461747573223a225570546f44617465227d2c7b22746362223a7b2269737673766e223a327d2c2274636244617465223a22323032332d30382d30395430303a30303a30305a222c22746362537461747573223a224f75744f6644617465227d5d7d5d2c227463624c6576656c73223a5b7b22746362223a7b22736778746362636f6d706f6e656e7473223a5b7b2273766e223a322c2263617465676f7279223a2242494f53222c2274797065223a224561726c79204d6963726f636f646520557064617465227d2c7b2273766e223a322c2263617465676f7279223a224f532f564d4d222c2274797065223a22534758204c617465204d6963726f636f646520557064617465227d2c7b2273766e223a322c2263617465676f7279223a224f532f564d4d222c2274797065223a225458542053494e4954227d2c7b2273766e223a322c2263617465676f7279223a2242494f53227d2c7b2273766e223a332c2263617465676f7279223a2242494f53227d2c7b2273766e223a312c2263617465676f7279223a2242494f53227d2c7b2273766e223a307d2c7b2273766e223a352c2263617465676f7279223a224f532f564d4d222c2274797065223a225345414d4c44522041434d227d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d5d2c2270636573766e223a31312c22746478746362636f6d706f6e656e7473223a5b7b2273766e223a352c2263617465676f7279223a224f532f564d4d222c2274797065223a22544458204d6f64756c65227d2c7b2273766e223a302c2263617465676f7279223a224f532f564d4d222c2274797065223a22544458204d6f64756c65227d2c7b2273766e223a322c2263617465676f7279223a224f532f564d4d222c2274797065223a22544458204c617465204d6963726f636f646520557064617465227d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d5d7d2c2274636244617465223a22323032342d30332d31335430303a30303a30305a222c22746362537461747573223a225570546f44617465227d2c7b22746362223a7b22736778746362636f6d706f6e656e7473223a5b7b2273766e223a322c2263617465676f7279223a2242494f53222c2274797065223a224561726c79204d6963726f636f646520557064617465227d2c7b2273766e223a322c2263617465676f7279223a224f532f564d4d222c2274797065223a22534758204c617465204d6963726f636f646520557064617465227d2c7b2273766e223a322c2263617465676f7279223a224f532f564d4d222c2274797065223a225458542053494e4954227d2c7b2273766e223a322c2263617465676f7279223a2242494f53227d2c7b2273766e223a332c2263617465676f7279223a2242494f53227d2c7b2273766e223a312c2263617465676f7279223a2242494f53227d2c7b2273766e223a307d2c7b2273766e223a352c2263617465676f7279223a224f532f564d4d222c2274797065223a225345414d4c44522041434d227d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d5d2c2270636573766e223a352c22746478746362636f6d706f6e656e7473223a5b7b2273766e223a352c2263617465676f7279223a224f532f564d4d222c2274797065223a22544458204d6f64756c65227d2c7b2273766e223a302c2263617465676f7279223a224f532f564d4d222c2274797065223a22544458204d6f64756c65227d2c7b2273766e223a322c2263617465676f7279223a224f532f564d4d222c2274797065223a22544458204c617465204d6963726f636f646520557064617465227d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d2c7b2273766e223a307d5d7d2c2274636244617465223a22323031382d30312d30345430303a30303a30305a222c22746362537461747573223a224f75744f6644617465222c2261647669736f7279494473223a5b22494e54454c2d53412d3030313036222c22494e54454c2d53412d3030313135222c22494e54454c2d53412d3030313335222c22494e54454c2d53412d3030323033222c22494e54454c2d53412d3030323230222c22494e54454c2d53412d3030323333222c22494e54454c2d53412d3030323730222c22494e54454c2d53412d3030323933222c22494e54454c2d53412d3030333230222c22494e54454c2d53412d3030333239222c22494e54454c2d53412d3030333831222c22494e54454c2d53412d3030333839222c22494e54454c2d53412d3030343737222c22494e54454c2d53412d3030383337225d7d5d7d"), 
        //     signature: hex"a26857764e98cde69df09b33874f93d575c6dc065978970931c5557b6fef0c029060fcc7befbb9863e922c2a0dafa057008aa407217476cb1d83ce800d23b8cf"});

        TcbInfoJsonObj memory tcbInfoObj = TcbInfoJsonObj({
            tcbInfoStr: string(tdx_tcbStr), 
            signature: tdx_signature
         });

        bytes32 attestationId = tcb.upsertFmspcTcb(tcbInfoObj);

        // tcb.getFmspcTcbV3(TcbId.TDX, 0xB0C06F000000);
        tcb.getFmspcTcbV3(TcbId.TDX, fmspcBytes);
    }

}