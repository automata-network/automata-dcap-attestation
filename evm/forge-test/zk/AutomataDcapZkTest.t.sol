// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import "../utils/PCCSSetupBase.sol";
import "../utils/RiscZeroSetup.sol";
import {Groth16Setup} from "../utils/succinct/Groth16Setup.sol";
import {PlonkSetup} from "../utils/succinct/PlonkSetup.sol";
import {ISP1Verifier} from "@sp1-contracts/ISP1Verifier.sol";
import "../../contracts/PCCSRouter.sol";
import "../../contracts/AutomataDcapAttestationFee.sol";
import "../../contracts/verifiers/V4QuoteVerifier.sol";

contract AutomataDcapZkTest is PCCSSetupBase, RiscZeroSetup {
    bytes constant platformCrlDer =
        hex"30820a6230820a08020101300a06082a8648ce3d04030230703122302006035504030c19496e74656c205347582050434b20506c6174666f726d204341311a3018060355040a0c11496e74656c20436f72706f726174696f6e3114301206035504070c0b53616e746120436c617261310b300906035504080c024341310b3009060355040613025553170d3235303630343039313933315a170d3235303730343039313933315a30820934303302146fc34e5023e728923435d61aa4b83c618166ad35170d3235303630343039313933315a300c300a0603551d1504030a01013034021500efae6e9715fca13b87e333e8261ed6d990a926ad170d3235303630343039313933315a300c300a0603551d1504030a01013034021500fd608648629cba73078b4d492f4b3ea741ad08cd170d3235303630343039313933315a300c300a0603551d1504030a010130340215008af924184e1d5afddd73c3d63a12f5e8b5737e56170d3235303630343039313933315a300c300a0603551d1504030a01013034021500b1257978cfa9ccdd0759abf8c5ca72fae3a78a9b170d3235303630343039313933315a300c300a0603551d1504030a01013033021474fea614a972be0e2843f2059835811ed872f9b3170d3235303630343039313933315a300c300a0603551d1504030a01013034021500f9c4ef56b3ab48d577e108baedf4bf88014214b9170d3235303630343039313933315a300c300a0603551d1504030a010130330214071de0778f9e5fc4f2878f30d6b07c9a30e6b30b170d3235303630343039313933315a300c300a0603551d1504030a01013034021500cde2424f972cea94ff239937f4d80c25029dd60b170d3235303630343039313933315a300c300a0603551d1504030a0101303302146c3319e5109b64507d3cf1132ce00349ef527319170d3235303630343039313933315a300c300a0603551d1504030a01013034021500df08d756b66a7497f43b5bb58ada04d3f4f7a937170d3235303630343039313933315a300c300a0603551d1504030a01013033021428af485b6cf67e409a39d5cb5aee4598f7a8fa7b170d3235303630343039313933315a300c300a0603551d1504030a01013034021500fb8b2daec092cada8aa9bc4ff2f1c20d0346668c170d3235303630343039313933315a300c300a0603551d1504030a01013034021500cd4850ac52bdcc69a6a6f058c8bc57bbd0b5f864170d3235303630343039313933315a300c300a0603551d1504030a01013034021500994dd3666f5275fb805f95dd02bd50cb2679d8ad170d3235303630343039313933315a300c300a0603551d1504030a0101303302140702136900252274d9035eedf5457462fad0ef4c170d3235303630343039313933315a300c300a0603551d1504030a01013033021461f2bf73e39b4e04aa27d801bd73d24319b5bf80170d3235303630343039313933315a300c300a0603551d1504030a0101303302143992be851b96902eff38959e6c2eff1b0651a4b5170d3235303630343039313933315a300c300a0603551d1504030a0101303302140fda43a00b68ea79b7c2deaeac0b498bdfb2af90170d3235303630343039313933315a300c300a0603551d1504030a010130330214639f139a5040fdcff191e8a4fb1bf086ed603971170d3235303630343039313933315a300c300a0603551d1504030a01013034021500959d533f9249dc1e513544cdc830bf19b7f1f301170d3235303630343039313933315a300c300a0603551d1504030a0101303302147ae37748a9f912f4c63ba7ab07c593ce1d1d1181170d3235303630343039313933315a300c300a0603551d1504030a01013033021413884b33269938c195aa170fca75da177538df0b170d3235303630343039313933315a300c300a0603551d1504030a0101303402150085d3c9381b77a7e04d119c9e5ad6749ff3ffab87170d3235303630343039313933315a300c300a0603551d1504030a0101303402150093887ca4411e7a923bd1fed2819b2949f201b5b4170d3235303630343039313933315a300c300a0603551d1504030a0101303302142498dc6283930996fd8bf23a37acbe26a3bed457170d3235303630343039313933315a300c300a0603551d1504030a010130340215008a66f1a749488667689cc3903ac54c662b712e73170d3235303630343039313933315a300c300a0603551d1504030a01013034021500afc13610bdd36cb7985d106481a880d3a01fda07170d3235303630343039313933315a300c300a0603551d1504030a01013034021500efe04b2c33d036aac96ca673bf1e9a47b64d5cbb170d3235303630343039313933315a300c300a0603551d1504030a0101303402150083d9ac8d8bb509d1c6c809ad712e8430559ed7f3170d3235303630343039313933315a300c300a0603551d1504030a0101303302147931fd50b5071c1bbfc5b7b6ded8b45b9d8b8529170d3235303630343039313933315a300c300a0603551d1504030a0101303302141fa20e2970bde5d57f7b8ddf8339484e1f1d0823170d3235303630343039313933315a300c300a0603551d1504030a0101303302141e87b2c3b32d8d23e411cef34197b95af0c8adf5170d3235303630343039313933315a300c300a0603551d1504030a010130340215009afd2ee90a473550a167d996911437c7502d1f09170d3235303630343039313933315a300c300a0603551d1504030a0101303302144481b0f11728a13b696d3ea9c770a0b15ec58dda170d3235303630343039313933315a300c300a0603551d1504030a01013034021500a7859f57982ef0e67d37bc8ef2ef5ac835ff1aa9170d3235303630343039313933315a300c300a0603551d1504030a010130340215009d67753b81e47090aea763fbec4c4549bcdb9933170d3235303630343039313933315a300c300a0603551d1504030a01013033021434bfbb7a1d9c568147e118b614f7b76ed3ef68df170d3235303630343039313933315a300c300a0603551d1504030a0101303302142c3cc6fe9279db1516d5ce39f2a898cda5a175e1170d3235303630343039313933315a300c300a0603551d1504030a010130330214717948687509234be979e4b7dce6f31bef64b68c170d3235303630343039313933315a300c300a0603551d1504030a010130340215009d76ef2c39c136e8658b6e7396b1d7445a27631f170d3235303630343039313933315a300c300a0603551d1504030a01013034021500c3e025fca995f36f59b48467939e3e34e6361a6f170d3235303630343039313933315a300c300a0603551d1504030a010130340215008c5f6b3257da05b17429e2e61ba965d67330606a170d3235303630343039313933315a300c300a0603551d1504030a01013034021500a17c51722ec1e0c3278fe8bdf052059cbec4e648170d3235303630343039313933315a300c300a0603551d1504030a0101a02f302d300a0603551d140403020101301f0603551d23041830168014956f5dcdbd1be1e94049c9d4f433ce01570bde54300a06082a8648ce3d0403020348003045022100c660c13d1c03e0c07e2fe2ae59fad9c6f06e6751babf526a23e40cffe978d46802206754f660e28572a046484f57e21ef2937a874d54b70e5beb72a13cc51d0b1de9";
    
    AutomataDcapAttestationFee attestation;
    V4QuoteVerifier quoteVerifier;
    PCCSRouter pccsRouter;

    Groth16Setup setupSp1Groth16 = new Groth16Setup();
    PlonkSetup setupSp1Plonk = new PlonkSetup();

    // STALE
    bytes32 riscZeroImageId = 0xcc80dc6c1c1f8bc524101b72b3900301dc87887457c8fcaf552e45e2a02b9695;
    bytes32 sp1DcapVkey = 0x004b1c0509dc0eee05ad437e3600027bd8cb3fbb03b29bf9cd839ae2e684c749;

    function setUp() public override {
        // this line is needed to bypass expiry reverts for stale quotes
        vm.warp(1749095100); // pinned June 5th, 2025, 3:45am UTC

        super.setUp();

        setUpRiscZero();
        vm.startPrank(admin);

        pccsRouter = setupPccsRouter(admin);
        
        pcsDaoUpserts();
        pcsDao.upsertPckCrl(CA.PLATFORM, platformCrlDer);
        
        enclaveIdDao.grantRoles(
            admin,
            enclaveIdDao.ATTESTER_ROLE()
        );
        qeIdDaoUpsert(4, "/forge-test/assets/0625/qe_td.json");

        fmspcTcbDao.grantRoles(
            admin,
            fmspcTcbDao.ATTESTER_ROLE()
        );
        fmspcTcbDaoUpsert("/forge-test/assets/0625/tcbinfov3_00806f050000.json");
        tcbEvalDaoUpsert("/forge-test/assets/0625/tdxtcbeval.json");

        attestation = new AutomataDcapAttestationFee(admin);
        quoteVerifier = new V4QuoteVerifier(P256_VERIFIER, address(pccsRouter));
        attestation.setQuoteVerifier(address(quoteVerifier));

        vm.stopPrank();
    }

    function testRiscZeroGroth16Verification() public {
        vm.prank(admin);
        attestation.setZkConfiguration(
            ZkCoProcessorType.RiscZero,
            ZkCoProcessorConfig({latestDcapProgramIdentifier: riscZeroImageId, defaultZkVerifier: address(riscZeroVerifier)})
        );

        bytes memory journal =
            hex"03b3000400020400806f05000004010700000000000000000000000000ffc97a88587660fb04e1f7c851300c96ae0b5a463ac46d035d16c2d9f36d0ed1d23775bcbd27deb219e3a3cc2802389500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000e700060000000000935be7742dd89c6a4df6dba8353d89041ae0f052beef993b1e7f4524d3bc57650df20e5582158352e1240b3f1fed55d80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d3030393630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d3030393832000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d303039383600000000000000000000000000000000000000000000684112bcfc0e9516fd61852b166d70295dbaef5128d5c4b963350becb43935b6a231aac1a7fa01fc7a25a72b367cd8bd6aed0bb37108920a3292f557465b91fac3a68eb10fa74a3f32c80b978c8ad671395dabf24283eef9091bc3919fd39b9915a87f1a5c939ffcb58648463f420bffe0c03e3580331c42fc4d48dbe05ae881cb4b1c1188b0758c525b2f28ee1896907de49511ffb1d919b04bd65b91943be6ebb0a5fe8476fa44b3f6223eed544e8908e9b0122afd8ef25db00eee78e8a850c51cf8a0";
        bytes memory seal =
            hex"73c457ba0e7a435a2038da25ff2c09f6c614386a686b5b6a6c0d5c36e3485944ecd22cb3093d7887e17975b289fe028a5d649d426ad23bf0abfc579a6992d59b201a254b07dc283e22ac5a848a04b6d946bb1fe2c93b13f9bc55a1a0a2b6545ab43d811f2f4f152a63921657faf46b55f99d8f99ce803df40b46f65d1c2d9f930d9c5b0b194c76621e3982d6c6ae558d12a4555bc68754ce860a07a6cad586992770c87324558438091301fb159b7b62b259a8a35e5ba8569b05ca5960a4db5cbac39b1f27ab3fce3af7b1fe02ef3f1f6419320f8cd370fb8485125b7c63d6be624d734d263143749f07224212f1da19c00a0408bc5c6c714bd40d30cf60b3fe2f4316c2";

        (bool success,) =
            attestation.verifyAndAttestWithZKProof(journal, ZkCoProcessorType.RiscZero, seal);

        assertTrue(success);
    }

    function testSP1Groth16Verification() public {
        ISP1Verifier sp1Groth16Verifier = ISP1Verifier(setupSp1Groth16.setup());

        vm.prank(admin);
        attestation.setZkConfiguration(
            ZkCoProcessorType.Succinct,
            ZkCoProcessorConfig({latestDcapProgramIdentifier: sp1DcapVkey, defaultZkVerifier: address(sp1Groth16Verifier)})
        );

        bytes memory output =
            hex"03b3000400020400806f05000004010700000000000000000000000000ffc97a88587660fb04e1f7c851300c96ae0b5a463ac46d035d16c2d9f36d0ed1d23775bcbd27deb219e3a3cc2802389500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000e700060000000000935be7742dd89c6a4df6dba8353d89041ae0f052beef993b1e7f4524d3bc57650df20e5582158352e1240b3f1fed55d80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d3030393630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d3030393832000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d303039383600000000000000000000000000000000000000000000684112bcfc0e9516fd61852b166d70295dbaef5128d5c4b963350becb43935b6a231aac1a7fa01fc7a25a72b367cd8bd6aed0bb37108920a3292f557465b91fac3a68eb10fa74a3f32c80b978c8ad671395dabf24283eef9091bc3919fd39b9915a87f1a5c939ffcb58648463f420bffe0c03e3580331c42fc4d48dbe05ae881cb4b1c1188b0758c525b2f28ee1896907de49511ffb1d919b04bd65b91943be6ebb0a5fe8476fa44b3f6223eed544e8908e9b0122afd8ef25db00eee78e8a850c51cf8a0";
        bytes memory proof =
            hex"a4594c592964967d0e4b44e8152644f7edd6de876286c73d60dade4930f0838b8f8a9aed2875e447bdda742c72455e01e935f8220ceacba81d1853fd42a378123a1571352e573058aef339c69700ce5050ee72e5a96db86e976e2ebdc394c03ba67e8d6e05fd29dcf9b9730aaa52bf52f86e0fd149b8c11fca8f8ef4898ea3b44344dad9193a10222a1e522396a4840177394815ee5602b224f26e513b9b058f02c830540534dc8cf0d328def205d3bb7b8289ab8680f764aa1f04e01dbeb257593bae5d24f0f59e9ad1bf8cba1b95acb1bcf8a8c0331240269920fa23ada70249ad1a901f4d66a45ea74023d09db71c895ce42248e0e9d98bab168f26f8cfb453e4897f";

        (bool success,) = attestation.verifyAndAttestWithZKProof(output, ZkCoProcessorType.Succinct, proof);

        assertTrue(success);
    }

    function testSP1PlonkVerification() public {
        ISP1Verifier sp1PlonkVerifier = ISP1Verifier(setupSp1Plonk.setup());

        vm.prank(admin);
        attestation.setZkConfiguration(
            ZkCoProcessorType.Succinct,
            ZkCoProcessorConfig({latestDcapProgramIdentifier: sp1DcapVkey, defaultZkVerifier: address(sp1PlonkVerifier)})
        );

        bytes memory output =
            hex"03b3000400020400806f05000004010700000000000000000000000000ffc97a88587660fb04e1f7c851300c96ae0b5a463ac46d035d16c2d9f36d0ed1d23775bcbd27deb219e3a3cc2802389500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000e700060000000000935be7742dd89c6a4df6dba8353d89041ae0f052beef993b1e7f4524d3bc57650df20e5582158352e1240b3f1fed55d80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d3030393630000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d3030393832000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d303039383600000000000000000000000000000000000000000000684112bcfc0e9516fd61852b166d70295dbaef5128d5c4b963350becb43935b6a231aac1a7fa01fc7a25a72b367cd8bd6aed0bb37108920a3292f557465b91fac3a68eb10fa74a3f32c80b978c8ad671395dabf24283eef9091bc3919fd39b9915a87f1a5c939ffcb58648463f420bffe0c03e3580331c42fc4d48dbe05ae881cb4b1c1188b0758c525b2f28ee1896907de49511ffb1d919b04bd65b91943be6ebb0a5fe8476fa44b3f6223eed544e8908e9b0122afd8ef25db00eee78e8a850c51cf8a0";
        bytes memory proof =
            hex"d4e8ecd22e1f658599eccfeaf49cc01b6efab88d7b9d5f308a6bdaf0df1274882aa04dc8243e15575e424b13afd8978716d8223207f4e678f37d33a5b365fc00b92a985004f893a0e6a6b90bc2a1bd4b664f3bc81a60e8580abdfde1a5929236d222b28c21a4bd845330255731743b48fbdb78d4a3fd4ba9c141af2601579a1c10a4d9aa2e038f1ea3c1e59d135e6c70a2808a588dcdbdf924574cbc0a30d9f4d2207d7a07573b6e3a7ae766ca3240e75513a693fd74c0d2c6e29829b61799a4c8a785c7081b26d86e4587bef5500ac43247c50aabf72ae6e172b642485f09c362d70ece0363347c6a591daa7f872dc9d91c987da1cdeec5c7a523b50d431df4c273a8ed2197e641d53bcebc19ae5db39e1ec6f2e56d5cb993d690e127e8e7f53e0e9230216fc7f70fd8ae0fad81c69581a578461804ceb4a73b4a9d1494c28712ee26022c7f73b30445630dc757e21d3172423e43859bb51228ff48e04b7e48aa0a38ec0834ec4eac0c45bc8aa8e4665a0d2b4e9b6d51bb47cb772519c3184d6b3255a62fec28c25ed60cd480ac17786ef470e05bcb8e64c8efb59ab7239aba75f3c3582059e6d0095a41fcd4b689f2549e8bfd1b68cfc7743a25e7cb42a6ed1fb67ab10884f1cca0b4bcbcf1f460e68aa1f27550d1004fd38005c4d90101994d5ec6b72c861940393e07f7c456fa181dd714fa30ef2528d3dcfc91e1bcefcf8fae828e0c099c9dfcd2784f7c5bd3acfdc5e206802a0960fde53b8b2830ba04efce70371d2401043a28eebef8393339a530ad8d096ce5f3258b4a5e23a08d4f2742d50b1fa0568d67bfcd877962fc5820cf0c45b21c043dfbd844c46deca3d08a6f800e2d12afef178beef7e313d1516c56785f3b99230389e44c0556f8a2488912c0f01aaa9bb1c878732e0171316fcf3b7ccd3a73a5e53aaaa7e450e730eb6bb3eef821a6de66cb17641263f3882658e507b8707c4f9d2354800c21e2c277cdc180d3239926ac414f740f44b6e3b1104443ab3b59914467fa72ac325435dec17c0f3c24f7a965c00ca8ae923f83ec45748b2cd225a56236be68a64f7e4e6994c210011195ad3bb7e019a59621c1ac73cf2a344e43b3899ab3f05365edbb5761ead76816a6f19c0aaf1223315ed8ea9083eb75a89fff2f55e92a4115cfb56bd1c2d3bd2c9ac4db8a5c0b2ceb5a051ac5b7b6631912541d49b35b01aa9730cd6277df1c";

        (bool success,) = attestation.verifyAndAttestWithZKProof(output, ZkCoProcessorType.Succinct, proof);

        assertTrue(success);
    }
}
