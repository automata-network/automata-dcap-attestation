# Automata DCAP Attestation

## Release Note

---

## zkProgram Identifiers

These identifiers are required parameters for SNARK proof verifications, to show that the proofs are generated by the intended zkVM Program.

The [ImageID](https://dev.risczero.com/terminology#image-id) currently for the DCAP RiscZero Guest Program is 0xcc80dc6c1c1f8bc524101b72b3900301dc87887457c8fcaf552e45e2a02b9695.

The [VKEY](https://docs.succinct.xyz/docs/sp1/verification/solidity-sdk#finding-your-program-vkey) currently for the DCAP SP1 Program is 0x008228a87e56a065fb3ad27026aef08acc97d72d289439e8dab0d53baaea9f26.

---

## Contract Deployment

Click [here](https://github.com/automata-network/automata-dcap-attestation/blob/v1.1.0/rust-crates/libraries/network-registry/deployment/current/DEPLOYMENT.md) to get the contract deployment info.

---

## What's Changed?

### EVM

- Introduction of `AutomataTcbEvalDao` contract to the PCCS. Provides onchain APIs for callers to query the `standard` or `early` update for a specific [TCB Recovery Event.](https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/best-practices/trusted-computing-base-recovery.html?wapkw=intel%20software%20guard%20extension%20trusted%20computing%20base%20recovery)

- Automata FMSPC DAO and Automata Enclave Identity DAO are now deployed as `AutomataFmspcTcbDaoVersioned` and `AutomataEnclaveIdentityDaoVersioned`. Each deployment instance (contract address) of a versioned DAO is tied to a specific TCB Evaluation Data Number. Users can easily determine an instanceâ€™s TCB Evaluation Data Number by calling the `TCB_EVALUATION_NUMBER()` method.

- Given the ability for users to now specify a TCB Recovery Event, the following function interfaces are added to `AutomataDcapAttestationFee`:
    
```solidity
function verifyAndAttestOnChain(bytes rawQuote, uint32 tcbEvalDataNumber);

function verifyAndAttestWithZkProof(
    bytes output,
    uint8 zkCoProcessor,
    bytes proof,
    bytes32 programIdentifier,
    uint32 tcbEvalDataNumber
);
```
    
These functions enable callers to use a specific TCB Evaluation Data Number for both onchain and ZK Quote verifications. Calling existing methods will simply fetch collaterals with the `standard` TCB Evaluation Data Number.
    
- `AutomataDcapAttestationFee` contract now supports multiple zkVM program identifiers for a single zkVM Configuration. This is to provide a grace period for users to transition from one version to another (especially after security patches, and does not immediately break the preceding version).
- Implemented Quote V5 verification. (Note: This slightly alters the format specification for the output data obtained after verifying a quote).
    
```solidity
// v1.0
struct Output {
    uint16 quoteVersion; // serialized as BE, for EVM compatibility
    bytes4 tee;
    uint8 tcbStatus;
    bytes6 fmspcBytes;
    bytes quoteBody;
    string[] advisoryIDs;
}

// v1.1+
struct Output {
    uint16 quoteVersion; // serialized as BE, for EVM compatibility
    uint16 quoteBodyType; // serialized as BE, for EVM compatibility
    uint8 tcbStatus;
    bytes6 fmspcBytes;
    bytes quoteBody;
    string[] advisoryIDs;
}
```
    
The 3rd and 4th bytes of the output data contains information about the quote body structure, to differentiate between SGX, TD1.0 and TD1.5 reports.
    
- Pico zkVM Integration (available for local testing only). Pico currently does not provide a remote prover. Users may generate their own proving and verifying keypair, and should then be able to test quote verification locally. See test [example](https://github.com/automata-network/automata-dcap-attestation/blob/v1.1/evm/forge-test/zk/AutomataDcapPicoZkTest.t.sol).
- [secp256r1 precompile](https://eips.ethereum.org/EIPS/eip-7951) support for Ethereum Hoodi and Sepolia with the Fusaka hardfork.
    - Reduces ECDSA verification cost from 330k gas to 6000 gas per signature.
    - ~1M gas reduction per DCAP quote onchain verification

### Solana

- Solana PCCS and DCAP Verifier with SP1 Integration (not-audited)
